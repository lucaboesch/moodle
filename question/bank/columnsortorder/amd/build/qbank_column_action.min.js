define("qbank_columnsortorder/qbank_column_action",["exports","core/notification","core/templates","core/sortable_list","jquery"],(function(_exports,_notification,_templates,_sortable_list,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Javascript for action on table columns.
   *
   * @module     qbank_columnsortorder/qbank_column_action
   * @copyright  2022 Catalyst IT Australia Pty Ltd
   * @author     Nathan Nguyen <nathannguyen@catalyst-ca.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */let table,dataIdAttribute,dataNameAttribute,currentHeader,currentPinnedHeader,currentX;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.setUpTable=_exports.setUpResizeHandle=_exports.setUpPinHandle=_exports.setUpMoveHandle=_exports.setUpHideShowDropdown=_exports.setUpCurrentPinnedColumns=_exports.setUpCurrentColumnSizes=void 0,_templates=_interopRequireDefault(_templates),_sortable_list=_interopRequireDefault(_sortable_list),_jquery=_interopRequireDefault(_jquery);const SELECTORS_MOVE_HANDLE='[data-action="move"]',SELECTORS_RESIZE_HANDLE='[data-action="resize"]',SELECTORS_PIN_HANDLE='[data-action="pin"]',SELECTORS_tableHeader=identifier=>"th[data-".concat(dataIdAttribute,'="').concat(identifier.replace(/["\\]/g,"\\$&"),'"]'),SELECTORS_tableColumn=identifier=>"td[data-".concat(dataIdAttribute,'="').concat(identifier.replace(/["\\]/g,"\\$&"),'"]'),SELECTORS_tableHeaderSection=tableid=>"#".concat(tableid," thead tr"),addHandle=(context,container)=>{_templates.default.renderForPromise("qbank_columnsortorder/action_handle",context).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.appendNodeContents(container,html,js),!0})).catch((ex=>(0,_notification.exception)(ex)))};_exports.setUpMoveHandle=(handleContainer,callback)=>{table.querySelectorAll("th").forEach((header=>{const context={action:"move",target:header.dataset[dataIdAttribute],title:header.dataset[dataNameAttribute],pixicon:"i/dragdrop",pixcomponent:"core"},container=header.querySelector(handleContainer);addHandle(context,container)})),new _sortable_list.default(SELECTORS_tableHeaderSection(table.id),{moveHandlerSelector:SELECTORS_MOVE_HANDLE}),(0,_jquery.default)(SELECTORS_tableHeaderSection(table.id)).on(_sortable_list.default.EVENTS.DRAGSTART,(event=>{event.currentTarget.classList.add("active")})),(0,_jquery.default)(SELECTORS_tableHeaderSection(table.id)).on(_sortable_list.default.EVENTS.DROP,(event=>{const header=event.target,insertAfter=header.previousElementSibling;table.querySelectorAll(SELECTORS_tableColumn(header.dataset[dataIdAttribute])).forEach((column=>{const row=column.parentElement;if(insertAfter){row.querySelector(SELECTORS_tableColumn(insertAfter.dataset[dataIdAttribute])).after(column)}else row.insertBefore(column,row.firstChild)})),table.querySelectorAll("tr").forEach((item=>item.classList.remove("active")));const columnOrder=(()=>{const tableHeaders=table.querySelectorAll("th"),columns=Array.from(tableHeaders).map((column=>column.dataset[dataIdAttribute]));return columns.filter(((value,index)=>columns.indexOf(value)===index))})();if(callback(columnOrder),currentPinnedHeader){const stopAtHeader=table.querySelector(SELECTORS_tableHeader(currentPinnedHeader));processPinnedHeaders(!0,stopAtHeader)}}))};const pinElement=(element,width,zIndex,left)=>{element.style.position="sticky",element.style.width=width+"px",element.style.zIndex=zIndex,element.style.left=left+"px",element.style.backgroundColor="wheat",element.classList.add("pinned")},unpinElement=element=>{element.style.position="",element.style.zIndex="",element.style.backgroundColor="",element.classList.remove("pinned")},processPinnedHeaders=(toBePinned,stopAtHeader)=>{let zIndex=999,left=0,pinnedHeaders=[];const tableHeaders=table.querySelectorAll("th");if(tableHeaders.forEach((header=>{unpinElement(header);table.querySelectorAll(SELECTORS_tableColumn(header.dataset[dataIdAttribute])).forEach((column=>{unpinElement(column)}))})),toBePinned){Array.prototype.slice.call(tableHeaders).some((header=>{zIndex-=1;const width=header.offsetWidth;pinnedHeaders.push(header.dataset[dataIdAttribute]),pinElement(header,width,zIndex,left);return table.querySelectorAll(SELECTORS_tableColumn(header.dataset[dataIdAttribute])).forEach((column=>{pinElement(column,width,zIndex,left)})),left+=width,header===stopAtHeader}))}return pinnedHeaders};_exports.setUpPinHandle=(handleContainer,callback)=>{table.querySelectorAll("th").forEach((header=>{const context={action:"pin",target:header.dataset[dataIdAttribute],title:header.dataset[dataNameAttribute],icon:'<i class="fa fa-thumb-tack mr-1" aria-hidden="true"></i>'},container=header.querySelector(handleContainer);addHandle(context,container)})),table.addEventListener("click",(function(e){const pinHandle=e.target.closest(SELECTORS_PIN_HANDLE);if(!pinHandle)return;const target=pinHandle.dataset.target,stopAtHeader=table.querySelector(SELECTORS_tableHeader(target));let toBePinned=!0;currentPinnedHeader===stopAtHeader.dataset[dataIdAttribute]?(toBePinned=!1,currentPinnedHeader=""):currentPinnedHeader=stopAtHeader.dataset[dataIdAttribute];const pinnedHeaders=processPinnedHeaders(toBePinned,stopAtHeader);callback(pinnedHeaders)}))};_exports.setUpResizeHandle=(handleContainer,callback)=>{table.querySelectorAll("th").forEach((header=>{const context={action:"resize",target:header.dataset[dataIdAttribute],title:header.dataset[dataNameAttribute],pixicon:"i/twoway",pixcomponent:"core"},container=header.querySelector(handleContainer);addHandle(context,container)})),table.addEventListener("mousedown",(function(e){const resizeHandle=e.target.closest(SELECTORS_RESIZE_HANDLE);if(!resizeHandle)return;currentX=e.pageX;const target=resizeHandle.dataset.target;currentHeader=table.querySelector(SELECTORS_tableHeader(target))})),table.addEventListener("mousemove",(function(e){if(!currentHeader||0===currentX)return;const offset=e.pageX-currentX;currentX=e.pageX;const newWidth=currentHeader.offsetWidth+offset;currentHeader.style.width=newWidth+"px"})),table.addEventListener("mouseup",(function(){if(!currentHeader||0===currentX)return;let columnSizes=[];table.querySelectorAll("th").forEach((header=>{let size={column:header.dataset[dataIdAttribute],width:header.style.width};columnSizes.push(size)})),callback(JSON.stringify(columnSizes)),currentHeader=null,currentX=0}))};_exports.setUpHideShowDropdown=(dropdownContainer,callback)=>{const container=document.querySelector(dropdownContainer);let currentHiddenColumns=table.dataset.hiddencolumns;currentHiddenColumns&&(currentHiddenColumns=JSON.parse(currentHiddenColumns));let context={columns:[],title:"Drop down menu",text:"Show/Hide Column",id:"showhidecolumn"};table.querySelectorAll("th").forEach((header=>{let visible=!0;if(currentHiddenColumns&&currentHiddenColumns.includes(header.dataset[dataIdAttribute])){visible=!1,header.style.display="none";table.querySelectorAll(SELECTORS_tableColumn(header.dataset[dataIdAttribute])).forEach((column=>{column.style.display="none"}))}const column={id:header.dataset[dataIdAttribute],name:header.dataset[dataNameAttribute],checked:visible};context.columns.push(column)})),_templates.default.renderForPromise("qbank_columnsortorder/checkbox_dropdown",context).then((_ref2=>{let{html:html,js:js}=_ref2;return _templates.default.appendNodeContents(container,html,js),!0})).then((()=>(addDropdownEventListener(container,callback),!0))).catch((ex=>(0,_notification.exception)(ex)))};const addDropdownEventListener=(container,callback)=>{container.querySelectorAll(".dropdown-item").forEach((item=>{item.addEventListener("click",(function(e){if("checkbox"!==e.target.type){item.querySelector("input[type=checkbox]").click()}}))}));const checkboxes=container.querySelectorAll("input[type=checkbox]");checkboxes.forEach((checkbox=>{checkbox.addEventListener("click",(function(e){const element=e.target,target=element.value,header=table.querySelector(SELECTORS_tableHeader(target));if(!0===element.checked){header.style.display="";table.querySelectorAll(SELECTORS_tableColumn(target)).forEach((column=>{column.style.display=""}))}else{header.style.display="none";table.querySelectorAll(SELECTORS_tableColumn(target)).forEach((column=>{column.style.display="none"}))}let hiddenColumns=[];checkboxes.forEach((checkbox=>{!1===checkbox.checked&&hiddenColumns.push(checkbox.value)})),callback(hiddenColumns)}))}))};_exports.setUpCurrentPinnedColumns=()=>{const currentPinnedColumns=table.dataset.pinnedcolumns;if(!currentPinnedColumns)return;const decodedPinnedColumns=JSON.parse(currentPinnedColumns);if(decodedPinnedColumns.length>0&&(currentPinnedHeader=decodedPinnedColumns[decodedPinnedColumns.length-1],""!==currentPinnedHeader)){const stopAtHeader=table.querySelector(SELECTORS_tableHeader(currentPinnedHeader));processPinnedHeaders(!0,stopAtHeader)}};_exports.setUpCurrentColumnSizes=()=>{const currentColumnSizes=table.dataset.colsize;if(currentColumnSizes){const decodedSizes=JSON.parse(currentColumnSizes);Array.isArray(decodedSizes)&&decodedSizes.forEach((colSize=>{if(""!==colSize.width){const header=table.querySelector(SELECTORS_tableHeader(colSize.column));header&&(header.style.width=colSize.width)}}))}};_exports.setUpTable=(id,dataIdAttr,dataNameAttr)=>{if(table=document.querySelector("#".concat(id)),"true"==table.dataset.setup)return!1;dataIdAttribute=dataIdAttr,dataNameAttribute=dataNameAttr;const tableHeaders=table.querySelectorAll("th");return table.querySelectorAll("tr").forEach((row=>{const columns=row.querySelectorAll("td");for(let i=0;i<columns.length;i++)columns[i].dataset[dataIdAttribute]=tableHeaders[i].dataset[dataIdAttribute]})),table.dataset.setup="true",!0}}));

//# sourceMappingURL=qbank_column_action.min.js.map